{% comment %} <!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Document</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      scroll-behavior: smooth;
    }

    .page-container {
      background-color: #b1b1b1;
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      height: 100vh;
    }

    .content {
      width: 80%;
      max-width: 500px;
      padding: 2rem;
      /* height: fit-content; */
      max-height: 80vh;
      background-color: #eef0f2;
      border-radius: 1rem;
      box-shadow: 0px 0px 1rem 0px rgba(0, 0, 0, 0.2);
      /* overflow-y: scroll; */

      display: grid;
      grid-template-rows: fit-content auto fit-content;
    }

    /* Hiding scrollbar for Chrome, Safari and Opera */
    .content::-webkit-scrollbar {
      display: none;
    }

    /* Hiding scrollbar for IE, Edge and Firefox */
    /* .content {
        scrollbar-width: none; 
        -ms-overflow-style: none;
      } */

    h1 {
      text-align: center;
      font-size: 1.5rem;
      margin-bottom: 1rem;
    }

    input[type="text"] {
      outline: none;
      border: none;
      padding: 0.5rem 1rem;
      background-color: #dadee1;
      border-radius: 2rem;
      width: 100%;
      text-align: center;
    }

    button {
      /* margin-top: 1rem; */
      border: 0;
      outline: 0;
      padding: 0.5rem 0.75rem;
      background-color: #1b1f24;
      border-radius: 2rem;
      color: #ffffff;
      font-size: 1.25rem;
      font-weight: bold;
      transition: 0.25s ease;
      cursor: pointer;
    }

    button:hover {
      background-color: #353a41;
      /* justify-self: start; */
    }

    form {
      margin-top: 1rem;
      display: grid;
      grid-template-columns: auto 2.5rem;
      gap: 0.5rem;
    }

    textarea {
      height: 5rem;
      resize: none;
      outline: none;
      border: none;
      padding: 0.5rem 1rem;
      background-color: #dadee1;
      border-radius: 0.5rem;
      width: 100%;
      overflow-y: scroll;
    }

    /* Hiding scrollbar for Chrome, Safari and Opera */
    textarea::-webkit-scrollbar {
      display: none;
    }

    /* Hiding scrollbar for IE, Edge and Firefox */
    textarea {
      scrollbar-width: none;
      /* Firefox */
      -ms-overflow-style: none;
      /* IE and Edge */
    }

    .single-message {
      width: fit-content;
      max-width: 60%;
      clear: both;
    }

    .msg-body {
      margin-top: 0.25rem;
      padding: 0.5rem;
      background-color: #ff7300;
      color: #ffffff;
      font-size: 1rem;
      border-radius: 0.25rem;
      word-wrap: break-word;
    }

    .sent {
      float: right;
    }

    .sent>.msg-body {
      background-color: #8c00ff;
    }

    .sender {
      margin-top: 0.25rem;
      font-size: 0.75rem;
    }

    .chats-container {
      width: 100%;
      height: 20rem;
      overflow-y: scroll;
    }

    /* Hiding scrollbar for Chrome, Safari and Opera */
    .chats-container::-webkit-scrollbar {
      display: none;
    }

    /* Hiding scrollbar for IE, Edge and Firefox */
    .chats-container {
      scrollbar-width: none;
      /* Firefox */
      -ms-overflow-style: none;
      /* IE and Edge */
    }
  </style>
</head>

<body>
  <div class="page-container">
    <div class="content">
      <h1>Welcome to {{room_name}}</h1>
      <div class="chats-container" id="chats-container">
        {%for message in messages%}
        {% if message.sender.lower == user.lower %}
        <div class="single-message sent">
          <div class="msg-body">{{message.message}}</div>
          <p class="sender">Me</p>
        </div>

        {% else %}
        <div class="single-message">
          <div class="msg-body">{{message.message}}</div>
          <p class="sender">{{message.sender}}</p>
        </div>
        {% endif %}
        {%endfor%}
        <!-- <div class="single-message sent">
            <div class="msg-body">
              Lorem ipsum dolor, sit amet consectetur adipisicing elit. Dolores,
              esse.
            </div>
            <p class="sender">Me</p>
          </div>
          <div class="single-message">
            <div class="msg-body">
              Lorem ipsum dolor, sit amet consectetur adipisicing elit. Dolores,
              esse.
            </div>
            <p class="sender">Sender</p>
          </div>
          <div class="single-message sent">
            <div class="msg-body">
              Lorem ipsum dolor, sit amet consectetur adipisicing elit. Dolores,
              esse.
            </div>
            <p class="sender">Me</p>
          </div>
          <div class="single-message">
            <div class="msg-body">
              Lorem ipsum dolor, sit amet consectetur adipisicing elit. Dolores,
              esse.
            </div>
            <p class="sender">Sender</p>
          </div>
          <div class="single-message sent">
            <div class="msg-body">
              Lorem ipsum dolor, sit amet consectetur adipisicing elit. Dolores,
              esse.
            </div>
            <p class="sender">Me</p>
          </div>
          <div class="single-message">
            <div class="msg-body">
              Lorem ipsum dolor, sit amet consectetur adipisicing elit. Dolores,
              esse.
            </div>
            <p class="sender">Sender</p>
          </div>-->
      </div>
      <form action="" id="msg-form" method="post">
        <!-- For the sake of security, all Django Post forms must have a csfr token tag -->
        <!-- {% csrf_token %} -->
        <textarea name="message" id="message" cols="30" rows="10" placeholder="Enter your message"></textarea>

        <button type="submit">&#10003;</button>
      </form>
    </div>
  </div>
  <script>

    const socketURL = `ws://${window.location.host}/ws/messages/{{room_name}}/`;
    console.log("Establishing Socket Connection")
    const socket = new WebSocket(socketURL)

    // Send Message to the backend
    const message_form = document.getElementById("msg-form")
    message_form.addEventListener("submit", function (event) {
      event.preventDefault();
      // console.log("Sending Message")
      let message_sent = document.getElementById("message").value;
      // console.log("Sending... ", message_sent);
      socket.send(
        JSON.stringify({
          message: message_sent,
          room_name: "{{room_name}}",
          sender: "{{user}}",
        })
      );
    });

    const chats_div = document.getElementById("chats-container")

    // Scroll to bottom
    const scrollToBottom = () => {
      chats_div.scrollTop = chats_div.scrollHeight;
    }


    // Recieve Message from the backend
    socket.addEventListener("message", (e) => {
      const data = JSON.parse(e.data)["message"]

      console.log(data);

      let sender = data["sender"]
      let content = data["message"]

      if (sender == "{{user}}") {
        document.getElementById("message").value = ""
      }

      if (sender == "{{user}}") {
        document.getElementById("message").value = ""
      }



      if (sender == "{{user}}") {
        chats_div.innerHTML += `<div class="single-message sent">
          <div class="msg-body">${content}</div>
          <p class="sender">Me</p>
        </div>`;
      } else {
        chats_div.innerHTML += `<div class="single-message">
          <div class="msg-body">${content}</div>
          <p class="sender">${sender}</p>
        </div>`;
      }

      scrollToBottom();

    });
  </script>
</body>

</html> {% endcomment %}
{% comment %} <!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat with {{ other_user }}</title>
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f0f0f0; }
.page-container { display:flex; justify-content:center; align-items:center; height:100vh; }
.content { width:400px; height:600px; background:#fff; border-radius:10px; display:flex; flex-direction:column; padding:1rem; }
.chats-container { flex:1; overflow-y:auto; margin-bottom:1rem; padding-right:0.5rem; }
.single-message { margin-bottom:0.5rem; max-width:70%; padding:0.5rem; border-radius:5px; word-wrap:break-word; }
.sent { background:#8c00ff; color:#fff; margin-left:auto; }
.received { background:#ff7300; color:#fff; margin-right:auto; }
.sender-name { font-size:0.75rem; margin-bottom:0.2rem; }
form { display:flex; width:100%; }
textarea { flex:1; padding:0.5rem; border-radius:5px; border:1px solid #ccc; resize:none; }
button { padding:0.5rem 1rem; margin-left:0.5rem; border:none; background:#667eea; color:#fff; border-radius:5px; cursor:pointer; }
</style>
</head>
<body>

<div class="page-container">
  <div class="content">
    <h3>Chat with {{ other_user }}</h3>

    <div class="chats-container" id="chats-container">
      {% for message in messages %}
        {% if message.sender == user %}
          <div class="single-message sent">{{ message.message }}</div>
        {% else %}
          <div class="sender-name">{{ message.sender }}</div>
          <div class="single-message received">{{ message.message }}</div>
        {% endif %}
      {% endfor %}
    </div>

    <form method="POST" action="{% url 'room' username=other_user %}">
      {% csrf_token %}
      <textarea name="message" rows="2" placeholder="Type a message..." required></textarea>
      <button type="submit">Send</button>
    </form>
  </div>
</div>

<script>
// Auto-scroll to bottom on load
const chatsContainer = document.getElementById("chats-container");
chatsContainer.scrollTop = chatsContainer.scrollHeight;

// Clear textarea and scroll after sending message
const form = document.querySelector('form');
const textarea = form.querySelector('textarea');

form.addEventListener('submit', () => {
    setTimeout(() => {
        textarea.value = '';
        chatsContainer.scrollTop = chatsContainer.scrollHeight;
    }, 100); // allow Django reload
});
</script>

</body>
</html> {% endcomment %}
{% comment %} <!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat with {{ other_user }}</title>
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f0f0f0; }
.page-container { display:flex; justify-content:center; align-items:center; height:100vh; }
.content { width:400px; height:600px; background:#fff; border-radius:10px; display:flex; flex-direction:column; padding:1rem; }
.chats-container { flex:1; overflow-y:auto; margin-bottom:1rem; padding-right:0.5rem; }
.single-message { margin-bottom:0.5rem; max-width:70%; padding:0.5rem; border-radius:5px; word-wrap:break-word; }
.sent { background:#8c00ff; color:#fff; margin-left:auto; }
.received { background:#ff7300; color:#fff; margin-right:auto; }
.sender-name { font-size:0.75rem; margin-bottom:0.2rem; }
form { display:flex; width:100%; }
textarea { flex:1; padding:0.5rem; border-radius:5px; border:1px solid #ccc; resize:none; }
button { padding:0.5rem 1rem; margin-left:0.5rem; border:none; background:#667eea; color:#fff; border-radius:5px; cursor:pointer; }
</style>
</head>
<body>

<div class="page-container">
  <div class="content">
    <h3>Chat with {{ other_user }}</h3>

    <div class="chats-container" id="chats-container">
      {% for message in messages %}
        {% if message.sender == user %}
          <div class="sender-name">Me</div>
          <div class="single-message sent">{{ message.message }}</div>
        {% else %}
          <div class="sender-name">{{ message.sender }}</div>
          <div class="single-message received">{{ message.message }}</div>
        {% endif %}
      {% endfor %}
    </div>

    <form method="POST" action="">
      {% csrf_token %}
      <textarea name="message" rows="2" placeholder="Type a message..." required></textarea>
      <button type="submit">Send</button>
    </form>
  </div>
</div>

<script>
// Auto-scroll to bottom on page load
const chatsContainer = document.getElementById("chats-container");
chatsContainer.scrollTop = chatsContainer.scrollHeight;
</script>

</body>
</html> {% endcomment %}
{% comment %} <!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Chat with {{ selected_user }}</title>
<style>
  body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f0f0f0; }
  .page-container { display:flex; width:100%; height:100vh; }

  /* Sidebar */
  .sidebar { width:220px; background:#eef0f2; padding:1rem; border-right:1px solid #ccc; overflow-y:auto; }
  .sidebar h3 { text-align:center; margin-bottom:1rem; }
  .sidebar ul { list-style:none; padding-left:0; }
  .sidebar li { padding:0.5rem 0; border-bottom:1px solid #ccc; text-align:center; }
  .user-btn { background:none; border:none; cursor:pointer; font-size:1rem; color:black; }
  .user-btn:hover { text-decoration:underline; color:#353a41; }

  /* Chat box */
  .content { flex:1; display:flex; justify-content:center; align-items:center; padding:1rem; }
  .chat-box { width:100%; max-width:500px; background:#eef0f2; border-radius:1rem; box-shadow:0 0 1rem rgba(0,0,0,0.2); display:flex; flex-direction:column; height:80vh; }
  .chat-header { padding:1rem; font-weight:bold; border-bottom:1px solid #ccc; text-align:center; }
  .messages { flex:1; padding:1rem; overflow-y:auto; }
  .sent { text-align:right; margin:5px; }
  .received { text-align:left; margin:5px; }
  .msg { display:inline-block; padding:8px 12px; border-radius:10px; background:#dcf8c6; }
  .received .msg { background:#fff; }
  .input-box { display:flex; padding:10px; border-top:1px solid #ccc; }
  textarea { flex:1; border-radius:5px; padding:5px; resize:none; }
  button.send-btn { padding:0.5rem 1rem; margin-left:0.5rem; border:none; background:#667eea; color:#fff; border-radius:5px; cursor:pointer; }
</style>
</head>
<body>

<div class="page-container">
  <!-- Sidebar -->
  <div class="sidebar">
    <h3>Users</h3>
    <ul>
      {% for u in users %}
        <li>
          <button class="user-btn" onclick="window.location='?user={{ u.username }}'">
            {{ u.username }}
          </button>
        </li>
      {% empty %}
        <li>No other users</li>
      {% endfor %}
    </ul>
  </div>

  <!-- Chat content -->
  <div class="content">
    {% if selected_user %}
      <div class="chat-box">
        <div class="chat-header">Chat with {{ selected_user }}</div>
        <div class="messages" id="chatMessages">
          {% for m in messages %}
            {% if m.sender == request.user.username %}
              <div class="sent"><span class="msg">{{ m.message }}</span></div>
            {% else %}
              <div class="received"><span class="msg">{{ m.message }}</span></div>
            {% endif %}
          {% endfor %}
        </div>
        <div class="input-box">
          <textarea id="messageInput" rows="2" placeholder="Type a message..."></textarea>
          <button id="sendBtn" class="send-btn">Send</button>
        </div>
      </div>
    {% else %}
      <div class="chat-box">
        <div class="chat-header">Select a user to start chatting</div>
      </div>
    {% endif %}
  </div>
</div>

<script>
// Elements
const chatsContainer = document.getElementById('chatMessages');
const sendBtn = document.getElementById('sendBtn');
const messageInput = document.getElementById('messageInput');

// WebSocket connection
const roomName = "{{ room_name }}"; // make sure room_name is sent from view
const socket = new WebSocket(`ws://${window.location.host}/ws/messages/${roomName}/`);

// Send message
sendBtn.addEventListener('click', () => {
  const message = messageInput.value.trim();
  if(!message) return;

  socket.send(JSON.stringify({
    'message': message,
    'sender': "{{ request.user.username }}"
  }));

  messageInput.value = '';
});

// Receive message
socket.onmessage = function(e) {
  const data = JSON.parse(e.data);
  const div = document.createElement('div');
  const span = document.createElement('span');
  span.className = 'msg';
  span.textContent = data.message;

  if(data.sender == "{{ request.user.username }}"){
    div.className = 'sent';
  } else {
    div.className = 'received';
  }

  div.appendChild(span);
  chatsContainer.appendChild(div);
  chatsContainer.scrollTop = chatsContainer.scrollHeight;
};

// Scroll on load
if(chatsContainer) chatsContainer.scrollTop = chatsContainer.scrollHeight;
</script>

</body>
</html> {% endcomment %}
{% comment %} <!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Chat with {{ selected_user }}</title>
<style>
  body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f0f0f0; }
  .page-container { display:flex; width:100%; height:100vh; }

  /* Sidebar */
  .sidebar { width:220px; background:#eef0f2; padding:1rem; border-right:1px solid #ccc; overflow-y:auto; }
  .sidebar h3 { text-align:center; margin-bottom:1rem; }
  .sidebar ul { list-style:none; padding-left:0; }
  .sidebar li { padding:0.5rem 0; border-bottom:1px solid #ccc; text-align:center; }
  .user-btn { background:none; border:none; cursor:pointer; font-size:1rem; color:black; }
  .user-btn:hover { text-decoration:underline; color:#353a41; }

  /* Chat box */
  .content { flex:1; display:flex; justify-content:center; align-items:center; padding:1rem; }
  .chat-box { width:100%; max-width:500px; background:#eef0f2; border-radius:1rem; box-shadow:0 0 1rem rgba(0,0,0,0.2); display:flex; flex-direction:column; height:80vh; }
  .chat-header { padding:1rem; font-weight:bold; border-bottom:1px solid #ccc; text-align:center; }
  .messages { flex:1; padding:1rem; overflow-y:auto; }
  .sent { text-align:right; margin:5px; }
  .received { text-align:left; margin:5px; }
  .msg { display:inline-block; padding:8px 12px; border-radius:10px; background:#dcf8c6; }
  .received .msg { background:#fff; }
  .input-box { display:flex; padding:10px; border-top:1px solid #ccc; }
  textarea { flex:1; border-radius:5px; padding:5px; resize:none; }
  button.send-btn { padding:0.5rem 1rem; margin-left:0.5rem; border:none; background:#667eea; color:#fff; border-radius:5px; cursor:pointer; }
</style>
</head>
<body>

<div class="page-container">
  <!-- Sidebar -->
  <div class="sidebar">
    <h3>Users</h3>
    <ul>
      {% for u in users %}
        <li>
          <button class="user-btn" onclick="window.location='?user={{ u.username }}'">
            {{ u.username }}
          </button>
        </li>
      {% empty %}
        <li>No other users</li>
      {% endfor %}
    </ul>
  </div>

  <!-- Chat content -->
  <div class="content">
    {% if selected_user %}
      <div class="chat-box">
        <div class="chat-header">Chat with {{ selected_user }}</div>
        <div class="messages" id="chatMessages">
          {% for m in messages %}
            {% if m.sender == request.user.username %}
              <div class="sent"><span class="msg">{{ m.message }}</span></div>
            {% else %}
              <div class="received"><span class="msg">{{ m.message }}</span></div>
            {% endif %}
          {% endfor %}
        </div>
        <div class="input-box">
          <textarea id="messageInput" rows="2" placeholder="Type a message..."></textarea>
          <button id="sendBtn" class="send-btn">Send</button>
        </div>
      </div>
    {% else %}
      <div class="chat-box">
        <div class="chat-header">Select a user to start chatting</div>
      </div>
    {% endif %}
  </div>
</div>

<script>
const chatsContainer = document.getElementById('chatMessages');
const sendBtn = document.getElementById('sendBtn');
const messageInput = document.getElementById('messageInput');

const roomName = "{{ room_name }}";
const socket = new WebSocket(`ws://${window.location.host}/ws/messages/${roomName}/`);

// Send message
sendBtn.addEventListener('click', () => {
  const message = messageInput.value.trim();
  if(!message) return;

  socket.send(JSON.stringify({
    'message': message,
    'sender': "{{ request.user.username }}"
  }));

  messageInput.value = '';
});

// Receive message
socket.onmessage = function(e) {
  const data = JSON.parse(e.data);
  const div = document.createElement('div');
  const span = document.createElement('span');
  span.className = 'msg';
  span.textContent = data.message;

  if(data.sender == "{{ request.user.username }}"){
    div.className = 'sent';
  } else {
    div.className = 'received';
  }

  div.appendChild(span);
  chatsContainer.appendChild(div);
  chatsContainer.scrollTop = chatsContainer.scrollHeight;
};

// Scroll on load
if(chatsContainer) chatsContainer.scrollTop = chatsContainer.scrollHeight;
</script>

</body>
</html> {% endcomment %}



{% comment %} <!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat with {{ selected_user }}</title>
<style>
body { font-family: Arial; margin:0; padding:0; background:#f0f0f0; }
.page-container { display:flex; height:100vh; }
.sidebar { width:220px; background:#eef0f2; padding:1rem; overflow-y:auto; }
.sidebar h3 { text-align:center; margin-bottom:1rem; }
.sidebar ul { list-style:none; padding-left:0; }
.sidebar li { padding:0.5rem 0; text-align:center; }
.user-btn { background:none; border:none; cursor:pointer; }
.user-btn:hover { text-decoration:underline; color:#353a41; }
.content { flex:1; display:flex; justify-content:center; align-items:center; padding:1rem; }
.chat-box { width:100%; max-width:500px; background:#eef0f2; border-radius:1rem; display:flex; flex-direction:column; height:80vh; }
.chat-header { padding:1rem; font-weight:bold; border-bottom:1px solid #ccc; text-align:center; }
.messages { flex:1; padding:1rem; overflow-y:auto; }
.sent { text-align:right; margin:5px; }
.received { text-align:left; margin:5px; }
.msg { display:inline-block; padding:8px 12px; border-radius:10px; background:#dcf8c6; }
.received .msg { background:#fff; }
.input-box { display:flex; padding:10px; border-top:1px solid #ccc; }
textarea { flex:1; border-radius:5px; padding:5px; resize:none; }
button.send-btn { padding:0.5rem 1rem; margin-left:0.5rem; border:none; background:#667eea; color:#fff; border-radius:5px; cursor:pointer; }
</style>
</head>
<body>

<div class="page-container">
  <!-- Sidebar -->
  <div class="sidebar">
    <h3>Users</h3>
    <ul>
      {% for u in users %}
        <li><button class="user-btn" onclick="window.location='?user={{ u.username }}'">{{ u.username }}</button></li>
      {% endfor %}
    </ul>
  </div>

  <!-- Chat -->
  <div class="content">
    {% if selected_user %}
      <div class="chat-box">
        <div class="chat-header">Chat with {{ selected_user }}</div>
        <div class="messages" id="chatMessages">
          {% for m in messages %}
            {% if m.sender == request.user.username %}
              <div class="sent"><span class="msg">{{ m.message }}</span></div>
            {% else %}
              <div class="received"><span class="msg">{{ m.message }}</span></div>
            {% endif %}
          {% endfor %}
        </div>
        <div class="input-box">
          <textarea id="messageInput" rows="2" placeholder="Type a message..."></textarea>
          <button id="sendBtn" class="send-btn">Send</button>
        </div>
      </div>
    {% else %}
      <div class="chat-box"><div class="chat-header">Select a user to start chatting</div></div>
    {% endif %}
  </div>
</div>

<script>
const roomName = "{{ room_name }}";
const username = "{{ request.user.username }}";
const chatMessages = document.getElementById("chatMessages");

const chatSocket = new WebSocket(
    "ws://" + window.location.host + "/ws/chat/" + roomName + "/"
);

// Send message
document.getElementById("sendBtn").onclick = () => {
    const input = document.getElementById("messageInput");
    const msg = input.value.trim();
    if (!msg) return;

    chatSocket.send(JSON.stringify({
        sender: username,
        message: msg,
        room_name: roomName
    }));
    input.value = "";
};

// Receive message
chatSocket.onmessage = function(e) {
    const data = JSON.parse(e.data); // data.message and data.sender are now top-level
    const div = document.createElement("div");
    div.className = data.sender === username ? "sent" : "received";
    div.innerHTML = `<span class="msg">${data.message}</span>`;
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
};

// Scroll to bottom on load
chatMessages.scrollTop = chatMessages.scrollHeight;
</script>

</body>
</html> {% endcomment %}






















{% comment %} <!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat with {{ selected_user }}</title>
<style>
body { font-family: Arial; margin:0; padding:0; background:#f0f0f0; }
.page-container { display:flex; height:100vh; }

/* Sidebar */
.sidebar { width:220px; background:#eef0f2; padding:1rem; overflow-y:auto; }
.sidebar h3 { text-align:center; margin-bottom:1rem; }
.sidebar ul { list-style:none; padding-left:0; }
.sidebar li { padding:0.5rem 0; text-align:center; }
.user-btn { background:none; border:none; cursor:pointer; }
.user-btn:hover { text-decoration:underline; color:#353a41; }

/* Chat box */
.content { flex:1; display:flex; justify-content:center; align-items:center; padding:1rem; }
.chat-box { width:100%; max-width:500px; background:#eef0f2; border-radius:1rem; display:flex; flex-direction:column; height:80vh; }
.chat-header { padding:1rem; font-weight:bold; border-bottom:1px solid #ccc; text-align:center; }
.messages { flex:1; padding:1rem; overflow-y:auto; }
.sent { text-align:right; margin:5px; }
.received { text-align:left; margin:5px; }
.msg { display:inline-block; padding:8px 12px; border-radius:10px; background:#dcf8c6; }
.received .msg { background:#fff; }
.input-box { display:flex; padding:10px; border-top:1px solid #ccc; }
textarea { flex:1; border-radius:5px; padding:5px; resize:none; }
button.send-btn { padding:0.5rem 1rem; margin-left:0.5rem; border:none; background:#667eea; color:#fff; border-radius:5px; cursor:pointer; }
</style>
</head>
<body>

<div class="page-container">
  <!-- Sidebar -->
  <div class="sidebar">
    <h3>Users</h3>
    <ul>
      {% for u in users %}
        <li><button class="user-btn" onclick="window.location='?user={{ u.username }}'">{{ u.username }}</button></li>
      {% empty %}
        <li>No other users</li>
      {% endfor %}
    </ul>
  </div>

  <!-- Chat -->
  <div class="content">
    {% if selected_user %}
      <div class="chat-box">
        <div class="chat-header">Chat with {{ selected_user }}</div>
        <div class="messages" id="chatMessages">
          {% for m in messages %}
            {% if m.sender == request.user.username %}
              <div class="sent"><span class="msg">{{ m.message }}</span></div>
            {% else %}
              <div class="received"><span class="msg">{{ m.message }}</span></div>
            {% endif %}
          {% endfor %}
        </div>
        <div class="input-box">
          <textarea id="messageInput" rows="2" placeholder="Type a message..."></textarea>
          <button id="sendBtn" class="send-btn">Send</button>
        </div>
      </div>
    {% else %}
      <div class="chat-box"><div class="chat-header">Select a user to start chatting</div></div>
    {% endif %}
  </div>
</div>

<script>
const roomName = "{{ room_name }}";
const username = "{{ request.user.username }}";
const receiver = "{{ selected_user }}"; // new
const chatMessages = document.getElementById("chatMessages");

const chatSocket = new WebSocket(
    "ws://" + window.location.host + "/ws/chat/" + roomName + "/"
);

// Send message with receiver info
document.getElementById("sendBtn").onclick = () => {
    const input = document.getElementById("messageInput");
    const msg = input.value.trim();
    if (!msg) return;

    chatSocket.send(JSON.stringify({
        sender: username,
        receiver: receiver,
        message: msg,
        room_name: roomName
    }));
    input.value = "";
};

// Receive message
chatSocket.onmessage = function (e) {
    const data = JSON.parse(e.data);

    // ðŸ”” ignore notifications here
    if (data.type === "notification") return;

    // ðŸ’¬ chat message
    if (data.type === "chat") {
        const div = document.createElement("div");
        div.className = data.sender === username ? "sent" : "received";
        div.innerHTML = `<span class="msg">${data.message}</span>`;
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
};
</script>

</body>
</html> {% endcomment %}
{% comment %} <!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat with {{ selected_user }}</title>
<style>
body { font-family: Arial; margin:0; padding:0; background:#f0f0f0; }
.page-container { display:flex; height:100vh; }

/* Sidebar */
.sidebar { width:220px; background:#eef0f2; padding:1rem; overflow-y:auto; }
.sidebar h3 { text-align:center; margin-bottom:1rem; }
.sidebar ul { list-style:none; padding-left:0; }
.sidebar li { padding:0.5rem 0; text-align:center; }
.user-btn { background:none; border:none; cursor:pointer; }
.user-btn:hover { text-decoration:underline; color:#353a41; }

/* Chat box */
.content { flex:1; display:flex; justify-content:center; align-items:center; padding:1rem; }
.chat-box { width:100%; max-width:500px; background:#eef0f2; border-radius:1rem; display:flex; flex-direction:column; height:80vh; box-shadow:0 0 1rem rgba(0,0,0,0.2);}
.chat-header { padding:1rem; font-weight:bold; border-bottom:1px solid #ccc; text-align:center; }
.messages { flex:1; padding:1rem; overflow-y:auto; }
.sent { text-align:right; margin:5px; }
.received { text-align:left; margin:5px; }
.msg { display:inline-block; padding:8px 12px; border-radius:10px; background:#dcf8c6; box-shadow:0 1px 3px rgba(0,0,0,0.1); }
.received .msg { background:#fff; }
.input-box { display:flex; padding:10px; border-top:1px solid #ccc; }
textarea { flex:1; border-radius:5px; padding:5px; resize:none; }
button.send-btn { padding:0.5rem 1rem; margin-left:0.5rem; border:none; background:#667eea; color:#fff; border-radius:5px; cursor:pointer; }

/* Notification toast */
#notification { position:fixed; top:10px; right:10px; background:#667eea; color:white; padding:10px; border-radius:5px; display:none; z-index:1000; }
</style>
</head>
<body>

<div id="notification"></div>

<div class="page-container">
  <!-- Sidebar -->
  <div class="sidebar">
    <h3>Users</h3>
    <ul>
      {% for u in users %}
        <li><button class="user-btn" onclick="window.location='?user={{ u.username }}'">{{ u.username }}</button></li>
      {% empty %}
        <li>No other users</li>
      {% endfor %}
    </ul>
  </div>

  <!-- Chat -->
  <div class="content">
    {% if selected_user %}
      <div class="chat-box">
        <div class="chat-header">Chat with {{ selected_user }}</div>
        <div class="messages" id="chatMessages">
          {% for m in messages %}
            {% if m.sender == request.user.username %}
              <div class="sent"><span class="msg">{{ m.message }}</span></div>
            {% else %}
              <div class="received"><span class="msg">{{ m.message }}</span></div>
            {% endif %}
          {% endfor %}
        </div>
        <div class="input-box">
          <textarea id="messageInput" rows="2" placeholder="Type a message..."></textarea>
          <button id="sendBtn" class="send-btn">Send</button>
        </div>
      </div>
    {% else %}
      <div class="chat-box"><div class="chat-header">Select a user to start chatting</div></div>
    {% endif %}
  </div>
</div>

<script>
const roomName = "{{ room_name }}";
const username = "{{ request.user.username }}";
const receiver = "{{ selected_user }}";
const chatMessages = document.getElementById("chatMessages");
const notificationDiv = document.getElementById("notification");
const chatSocket = new WebSocket("ws://" + window.location.host + "/ws/chat/" + roomName + "/");

// Function to show toast notifications
function showNotification(text){
    notificationDiv.textContent = text;
    notificationDiv.style.display = "block";
    setTimeout(()=>{ notificationDiv.style.display="none"; }, 3000);
}

// Send message
document.getElementById("sendBtn").onclick = () => {
    const input = document.getElementById("messageInput");
    const msg = input.value.trim();
    if(!msg) return;

    chatSocket.send(JSON.stringify({
        sender: username,
        receiver: receiver,
        message: msg,
        room_name: roomName,
        type: "chat"
    }));
    input.value = "";
};

// Press Enter to send (Shift+Enter for newline)
document.getElementById("messageInput").addEventListener("keydown", function(e){
    if(e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        document.getElementById("sendBtn").click();
    }
});

// Receive messages
chatSocket.onmessage = function(e){
    const data = JSON.parse(e.data);

    // Notifications
    if(data.type === "notification"){
        showNotification(data.text);
        return;
    }

    // Chat messages
    if(data.type === "chat"){
        const div = document.createElement("div");
        div.className = data.sender === username ? "sent" : "received";
        div.innerHTML = `<span class="msg">${data.message}</span>`;
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
};

// Scroll to bottom on load
if(chatMessages) chatMessages.scrollTop = chatMessages.scrollHeight;
</script>

</body>
</html> {% endcomment %}
{% comment %} <!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat</title>

<style>
body { font-family: Arial; margin:0; background:#f0f0f0; }
.page-container { display:flex; height:100vh; }

/* Sidebar */
.sidebar { width:260px; background:#fff; border-right:1px solid #ddd; overflow-y:auto; }
.user-item {
  padding:12px;
  cursor:pointer;
  border-bottom:1px solid #eee;
  display:flex;
  justify-content:space-between;
}
.user-item:hover { background:#f5f5f5; }
.username { font-weight:bold; }
.time { font-size:12px; color:gray; }

/* Chat */
.content { flex:1; display:flex; justify-content:center; align-items:center; }
.chat-box { width:100%; max-width:500px; height:85vh; background:#e5ddd5; display:flex; flex-direction:column; }
.chat-header { padding:12px; background:#075e54; color:white; font-weight:bold; }
.messages { flex:1; padding:10px; overflow-y:auto; }
.sent { text-align:right; margin:5px; }
.received { text-align:left; margin:5px; }
.msg { display:inline-block; padding:8px 12px; border-radius:10px; background:#dcf8c6; }
.received .msg { background:#fff; }
.input-box { display:flex; padding:10px; background:#f0f0f0; }
textarea { flex:1; resize:none; }
button { margin-left:5px; }
</style>
</head>

<body>

<div class="page-container">

<!-- USERS -->
<div class="sidebar" id="userList">
  {% for u in users %}
  <div class="user-item" data-user="{{ u.username }}" onclick="selectUser('{{ u.username }}')">
    <span class="username">{{ u.username }}</span>
    <span class="time" id="time-{{ u.username }}">--:--</span>
  </div>
  {% endfor %}
</div>

<!-- CHAT -->
<div class="content">
{% if selected_user %}
<div class="chat-box">
  <div class="chat-header">Chat with {{ selected_user }}</div>

  <div class="messages" id="chatMessages">
    {% for m in messages %}
      <div class="{% if m.sender == request.user.username %}sent{% else %}received{% endif %}">
        <span class="msg">{{ m.message }}</span>
      </div>
    {% endfor %}
  </div>

  <div class="input-box">
    <textarea id="messageInput" rows="2"></textarea>
    <button id="sendBtn">Send</button>
  </div>
</div>
{% else %}
<h3>Select a user to start chat</h3>
{% endif %}
</div>

</div>

<script>
const roomName = "{{ room_name }}";
const username = "{{ request.user.username }}";
const receiver = "{{ selected_user }}";
const socket = roomName ? new WebSocket(
  "ws://" + window.location.host + "/ws/chat/" + roomName + "/"
) : null;

function selectUser(user){
  window.location = "?user=" + user;
}

/* Move user to top */
function moveUserToTop(user){
  const list = document.getElementById("userList");
  const item = document.querySelector(`[data-user='${user}']`);
  if(item) list.prepend(item);
}

/* Update time */
function updateTime(user){
  const timeSpan = document.getElementById("time-" + user);
  if(timeSpan){
    const now = new Date();
    timeSpan.innerText =
      now.getHours().toString().padStart(2,"0") + ":" +
      now.getMinutes().toString().padStart(2,"0");
  }
}

if(socket){
  document.getElementById("sendBtn").onclick = () => {
    const input = document.getElementById("messageInput");
    const msg = input.value.trim();
    if(!msg) return;

    socket.send(JSON.stringify({
      sender: username,
      receiver: receiver,
      message: msg,
      room_name: roomName
    }));

    input.value = "";
    moveUserToTop(receiver);
    updateTime(receiver);
  };

  socket.onmessage = function(e){
    const data = JSON.parse(e.data);

    const div = document.createElement("div");
    div.className = data.sender === username ? "sent" : "received";
    div.innerHTML = `<span class="msg">${data.message}</span>`;
    document.getElementById("chatMessages").appendChild(div);

    const chatWith = data.sender === username ? receiver : data.sender;
    moveUserToTop(chatWith);
    updateTime(chatWith);
  };
}
</script>

</body>
</html> {% endcomment %}
















{% comment %} <!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Chat</title>
<style>
body { margin:0; font-family:Arial; background:#f0f0f0; }
.page-container { display:flex; height:100vh; }

.sidebar {
  width:220px;
  background:#eef0f2;
  padding:1rem;
  overflow-y:auto;
}
.sidebar h3 { text-align:center; }
.sidebar ul { list-style:none; padding:0; }
.sidebar li { padding:6px 0; text-align:center; }

.user-btn {
  background:none;
  border:none;
  cursor:pointer;
  font-size:15px;
}
.user-btn:hover { text-decoration:underline; }

.content {
  flex:1;
  display:flex;
  justify-content:center;
  align-items:center;
}
.chat-box {
  width:100%;
  max-width:500px;
  height:80vh;
  background:#eef0f2;
  border-radius:1rem;
  display:flex;
  flex-direction:column;
}
.chat-header {
  padding:1rem;
  font-weight:bold;
  text-align:center;
  border-bottom:1px solid #ccc;
}
.messages {
  flex:1;
  padding:1rem;
  overflow-y:auto;
}
.sent { text-align:right; }
.received { text-align:left; }
.msg {
  padding:8px 12px;
  border-radius:10px;
  background:#dcf8c6;
  display:inline-block;
  margin:4px;
}
.received .msg { background:#fff; }

.input-box {
  display:flex;
  padding:10px;
  border-top:1px solid #ccc;
}
textarea { flex:1; resize:none; }
.send-btn {
  margin-left:5px;
  padding:6px 12px;
  border:none;
  background:#667eea;
  color:white;
  border-radius:5px;
}
</style>
</head>

<body>

<div class="page-container">

  <!-- USERS -->
  <div class="sidebar">
    <h3>Users</h3>
    <ul id="userList">
      {% for u in users %}
      <li data-user="{{ u.username }}">
        <button class="user-btn" onclick="selectUser('{{ u.username }}')">
          {{ u.username }}
        </button>
      </li>
      {% endfor %}
    </ul>
  </div>

  <!-- CHAT -->
  <div class="content">
    {% if selected_user %}
    <div class="chat-box">
      <div class="chat-header">Chat with {{ selected_user }}</div>

      <div class="messages" id="chatMessages">
        {% for m in messages %}
          {% if m.sender == request.user.username %}
            <div class="sent"><span class="msg">{{ m.message }}</span></div>
          {% else %}
            <div class="received"><span class="msg">{{ m.message }}</span></div>
          {% endif %}
        {% endfor %}
      </div>

      <div class="input-box">
        <textarea id="messageInput" rows="2"></textarea>
        <button id="sendBtn" class="send-btn">Send</button>
      </div>
    </div>
    {% else %}
    <div class="chat-box">
      <div class="chat-header">Select user</div>
    </div>
    {% endif %}
  </div>

</div>

<script>
const username = "{{ request.user.username }}";
const receiver = "{{ selected_user }}";
const roomName = "{{ room_name }}";
const userList = document.getElementById("userList");
const chatMessages = document.getElementById("chatMessages");

/* ===== RESTORE ORDER (TOP FIRST) ===== */
document.addEventListener("DOMContentLoaded", () => {
  const order = JSON.parse(localStorage.getItem("chatOrder") || "[]");
  order.slice().reverse().forEach(u => {
    const li = document.querySelector(`li[data-user="${u}"]`);
    if (li) userList.prepend(li);
  });
});

/* ===== MOVE USER TO TOP ===== */
function moveUserToTop(user){
  const li = document.querySelector(`li[data-user="${user}"]`);
  if (!li) return;

  userList.prepend(li);

  let order = JSON.parse(localStorage.getItem("chatOrder") || "[]");
  order = order.filter(u => u !== user);
  order.unshift(user);
  localStorage.setItem("chatOrder", JSON.stringify(order));
}

/* ===== CLICK USER ===== */
function selectUser(user){
  moveUserToTop(user);
  window.location = "?user=" + user;
}

/* ===== SOCKET ===== */
if(roomName){
  const socket = new WebSocket(
    "ws://" + window.location.host + "/ws/chat/" + roomName + "/"
  );

  function appendMessage(sender, msg){
    const div = document.createElement("div");
    div.className = sender === username ? "sent" : "received";
    div.innerHTML = `<span class="msg">${msg}</span>`;
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  // Receive messages
  socket.onmessage = function(e){
    const data = JSON.parse(e.data);
    if(data.type === "chat"){
      appendMessage(data.sender, data.message);
      moveUserToTop(data.sender === username ? receiver : data.sender);
    }
  };

  // Send messages
  document.getElementById("sendBtn").onclick = () => {
    const input = document.getElementById("messageInput");
    const msg = input.value.trim();
    if(!msg) return;

    socket.send(JSON.stringify({
      type: "chat",
      sender: username,
      receiver: receiver,
      message: msg,
      room_name: roomName
    }));

    appendMessage(username, msg); // <-- show message immediately
    input.value = "";
  };

  // Press Enter to send
  document.getElementById("messageInput").addEventListener("keydown", function(e){
    if(e.key === "Enter" && !e.shiftKey){
      e.preventDefault();
      document.getElementById("sendBtn").click();
    }
  });
}
</script>

</body>
</html> {% endcomment %}


{% comment %} <!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Chat</title>
<style>
body { margin:0; font-family:Arial; background:#f0f0f0; }
.page-container { display:flex; height:100vh; }

.sidebar {
  width:220px;
  background:#eef0f2;
  padding:1rem;
  overflow-y:auto;
}
.sidebar h3 { text-align:center; }
.sidebar ul { list-style:none; padding:0; }
.sidebar li { padding:6px 0; text-align:center; }

.user-btn {
  background:none;
  border:none;
  cursor:pointer;
  font-size:15px;
}
.user-btn:hover { text-decoration:underline; }

.content {
  flex:1;
  display:flex;
  justify-content:center;
  align-items:center;
}
.chat-box {
  width:100%;
  max-width:500px;
  height:80vh;
  background:#eef0f2;
  border-radius:1rem;
  display:flex;
  flex-direction:column;
}
.chat-header {
  padding:1rem;
  font-weight:bold;
  text-align:center;
  border-bottom:1px solid #ccc;
}
.messages {
  flex:1;
  padding:1rem;
  overflow-y:auto;
}
.sent { text-align:right; }
.received { text-align:left; }
.msg {
  padding:8px 12px;
  border-radius:10px;
  background:#dcf8c6;
  display:inline-block;
  margin:4px;
}
.received .msg { background:#fff; }

.input-box {
  display:flex;
  padding:10px;
  border-top:1px solid #ccc;
}
textarea { flex:1; resize:none; }
.send-btn {
  margin-left:5px;
  padding:6px 12px;
  border:none;
  background:#667eea;
  color:white;
  border-radius:5px;
}
</style>
</head>

<body>

<div class="page-container">

  <!-- USERS -->
  <div class="sidebar">
    <h3>Users</h3>
    <ul id="userList">
      {% for u in users %}
      <li data-user="{{ u.username }}">
        <button class="user-btn" onclick="selectUser('{{ u.username }}')">
          {{ u.username }}
        </button>
      </li>
      {% endfor %}
    </ul>
  </div>

  <!-- CHAT -->
  <div class="content">
    {% if selected_user %}
    <div class="chat-box">
      <div class="chat-header">Chat with {{ selected_user }}</div>

      <div class="messages" id="chatMessages">
        {% for m in messages %}
          {% if m.sender == request.user.username %}
            <div class="sent"><span class="msg">{{ m.message }}</span></div>
          {% else %}
            <div class="received"><span class="msg">{{ m.message }}</span></div>
          {% endif %}
        {% endfor %}
      </div>

      <div class="input-box">
        <textarea id="messageInput" rows="2"></textarea>
        <button id="sendBtn" class="send-btn">Send</button>
      </div>
    </div>
    {% else %}
    <div class="chat-box">
      <div class="chat-header">Select user</div>
    </div>
    {% endif %}
  </div>

</div>

<script>
const username = "{{ request.user.username }}";
const receiver = "{{ selected_user }}";
const roomName = "{{ room_name }}";
const userList = document.getElementById("userList");
const chatMessages = document.getElementById("chatMessages");

/* ===== RESTORE ORDER (TOP FIRST) ===== */
document.addEventListener("DOMContentLoaded", () => {
  const order = JSON.parse(localStorage.getItem("chatOrder") || "[]");
  order.slice().reverse().forEach(u => {
    const li = document.querySelector(`li[data-user="${u}"]`);
    if (li) userList.prepend(li);
  });
});

/* ===== MOVE USER TO TOP ===== */
function moveUserToTop(user){
  const li = document.querySelector(`li[data-user="${user}"]`);
  if (!li) return;

  userList.prepend(li);

  let order = JSON.parse(localStorage.getItem("chatOrder") || "[]");
  order = order.filter(u => u !== user);
  order.unshift(user);
  localStorage.setItem("chatOrder", JSON.stringify(order));
}

/* ===== CLICK USER ===== */
function selectUser(user){
  moveUserToTop(user);
  window.location = "?user=" + user;
}

/* ===== SOCKET ===== */
if(roomName){
  const socket = new WebSocket(
    "ws://" + window.location.host + "/ws/chat/" + roomName + "/"
  );

  function appendMessage(sender, msg){
    const div = document.createElement("div");
    div.className = sender === username ? "sent" : "received";
    div.innerHTML = `<span class="msg">${msg}</span>`;
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  // Receive messages
  socket.onmessage = function(e){
    const data = JSON.parse(e.data);
    if(data.type === "chat"){
      appendMessage(data.sender, data.message);
      moveUserToTop(data.sender === username ? receiver : data.sender);
    }
  };

  // Send messages
  document.getElementById("sendBtn").onclick = () => {
    const input = document.getElementById("messageInput");
    const msg = input.value.trim();
    if(!msg) return;

    socket.send(JSON.stringify({
      type: "chat",
      sender: username,
      receiver: receiver,
      message: msg,
      room_name: roomName
    }));

    input.value = ""; // <- removed appendMessage here to prevent duplicate
  };

  // Press Enter to send
  document.getElementById("messageInput").addEventListener("keydown", function(e){
    if(e.key === "Enter" && !e.shiftKey){
      e.preventDefault();
      document.getElementById("sendBtn").click();
    }
  });
}
</script>

</body>
</html> {% endcomment %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Chat</title>
<style>
body { margin:0; font-family:Arial; background:#f0f0f0; }
.page-container { display:flex; height:100vh; }

.sidebar {
  width:220px;
  background:#eef0f2;
  padding:1rem;
  overflow-y:auto;
}
.sidebar h3 { text-align:center; }
.sidebar ul { list-style:none; padding:0; }
.sidebar li { padding:6px 0; text-align:center; display:flex; justify-content:space-between; align-items:center; }

.user-btn {
  background:none;
  border:none;
  cursor:pointer;
  font-size:15px;
  flex:1;
  text-align:left;
}
.user-btn:hover { text-decoration:underline; }

.unread {
  background:#e74c3c;
  color:white;
  border-radius:50%;
  padding:2px 6px;
  font-size:12px;
  display:none;
}

.content {
  flex:1;
  display:flex;
  justify-content:center;
  align-items:center;
}
.chat-box {
  width:100%;
  max-width:500px;
  height:80vh;
  background:#eef0f2;
  border-radius:1rem;
  display:flex;
  flex-direction:column;
}
.chat-header {
  padding:1rem;
  font-weight:bold;
  text-align:center;
  border-bottom:1px solid #ccc;
}
.messages {
  flex:1;
  padding:1rem;
  overflow-y:auto;
}
.sent { text-align:right; }
.received { text-align:left; }
.msg {
  padding:8px 12px;
  border-radius:10px;
  background:#dcf8c6;
  display:inline-block;
  margin:4px;
}
.received .msg { background:#fff; }

.input-box {
  display:flex;
  padding:10px;
  border-top:1px solid #ccc;
}
textarea { flex:1; resize:none; }
.send-btn {
  margin-left:5px;
  padding:6px 12px;
  border:none;
  background:#667eea;
  color:white;
  border-radius:5px;
}
</style>
</head>

<body>

<div class="page-container">

  <!-- USERS -->
  <div class="sidebar">
    <h3>Users</h3>
    <ul id="userList">
      {% for u in users %}
      <li data-user="{{ u.username }}">
        <button class="user-btn" onclick="selectUser('{{ u.username }}')">
          {{ u.username }}
        </button>
        <span class="unread" id="unread-{{ u.username }}">0</span>
      </li>
      {% endfor %}
    </ul>
  </div>

  <!-- CHAT -->
  <div class="content">
    {% if selected_user %}
    <div class="chat-box">
      <div class="chat-header">Chat with {{ selected_user }}</div>

      <div class="messages" id="chatMessages">
        {% for m in messages %}
          {% if m.sender == request.user.username %}
            <div class="sent"><span class="msg">{{ m.message }}</span></div>
          {% else %}
            <div class="received"><span class="msg">{{ m.message }}</span></div>
          {% endif %}
        {% endfor %}
      </div>

      <div class="input-box">
        <textarea id="messageInput" rows="2"></textarea>
        <button id="sendBtn" class="send-btn">Send</button>
      </div>
    </div>
    {% else %}
    <div class="chat-box">
      <div class="chat-header">Select user</div>
    </div>
    {% endif %}
  </div>

</div>

<script>
const username = "{{ request.user.username }}";
const receiver = "{{ selected_user }}";
const roomName = "{{ room_name }}";
const userList = document.getElementById("userList");
const chatMessages = document.getElementById("chatMessages");

/* âœ… ADD: track last sent message to avoid duplicate echo */
let lastSentMessage = null;

/* ===== RESTORE ORDER (TOP FIRST) ===== */
document.addEventListener("DOMContentLoaded", () => {
  const order = JSON.parse(localStorage.getItem("chatOrder") || "[]");
  order.slice().reverse().forEach(u => {
    const li = document.querySelector(`li[data-user="${u}"]`);
    if (li) userList.prepend(li);
  });
});

/* ===== MOVE USER TO TOP ===== */
function moveUserToTop(user){
  const li = document.querySelector(`li[data-user="${user}"]`);
  if (!li) return;

  userList.prepend(li);

  let order = JSON.parse(localStorage.getItem("chatOrder") || "[]");
  order = order.filter(u => u !== user);
  order.unshift(user);
  localStorage.setItem("chatOrder", JSON.stringify(order));
}

/* ===== CLICK USER ===== */
function selectUser(user){
  moveUserToTop(user);

  // Reset unread count when opening chat
  const unreadSpan = document.getElementById("unread-" + user);
  if(unreadSpan){
    unreadSpan.style.display = "none";
    unreadSpan.textContent = "0";
  }

  window.location = "?user=" + user;
}

/* ===== SOCKET ===== */
if(roomName){
  const socket = new WebSocket(
    "ws://" + window.location.host + "/ws/chat/" + roomName + "/"
  );

  function appendMessage(sender, msg){
    const div = document.createElement("div");
    div.className = sender === username ? "sent" : "received";
    div.innerHTML = `<span class="msg">${msg}</span>`;
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  // Receive messages
  socket.onmessage = function(e){
    const data = JSON.parse(e.data);

    if(data.type === "chat"){

      /* âœ… ADD: prevent duplicate message echo */
      if(data.sender === username && data.message === lastSentMessage){
        lastSentMessage = null;
        return;
      }

      appendMessage(data.sender, data.message);

      // Show unread count if not active chat
      if(data.sender !== username && receiver !== data.sender){
        const unreadSpan = document.getElementById("unread-" + data.sender);
        if(unreadSpan){
          let count = parseInt(unreadSpan.textContent) || 0;
          count += 1;
          unreadSpan.textContent = count;
          unreadSpan.style.display = "inline-block";
        }
      }

      moveUserToTop(data.sender === username ? receiver : data.sender);
    }
  };

  // Send messages
  document.getElementById("sendBtn").onclick = () => {
    const input = document.getElementById("messageInput");
    const msg = input.value.trim();
    if(!msg) return;

    /* âœ… ADD: store last sent message */
    lastSentMessage = msg;

    socket.send(JSON.stringify({
      type: "chat",
      sender: username,
      receiver: receiver,
      message: msg,
      room_name: roomName
    }));

    appendMessage(username, msg); // show message immediately
    input.value="";
  };

  // Press Enter to send
  document.getElementById("messageInput").addEventListener("keydown", function(e){
    if(e.key === "Enter" && !e.shiftKey){
      e.preventDefault();
      document.getElementById("sendBtn").click();
    }
  });
}
</script>

</body>
</html>
